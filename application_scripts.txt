// application_scripts.js

// NOTE: The `collegePrograms` variable MUST be defined in a script tag in the HTML/PHP
// before this file is included, e.g., const collegePrograms = {...};

// =================================================================
// 1. CORE VALIDATION AND UI LOGIC
// =================================================================

/**
 * Validates a single input field based on its data-validate-type attribute.
 * Updates the UI (.validated/.error classes) and returns the validation status.
 * @param {HTMLElement} input The input, select, or textarea element.
 * @returns {boolean} True if the field is valid, false otherwise.
 */
function validateField(input) {
  const parentWrapper = input.closest(".form-group-validation-wrapper");

  // Check for elements that are hidden by CSS or conditional logic
  if (!parentWrapper || parentWrapper.offsetParent === null) {
    return true; // Ignore validation for hidden fields
  }

  const value = input.value.trim();
  const type = input.getAttribute("data-validate-type");
  let isValid = true;

  // Check if the field is a standard input/select/textarea
  const isStandardField = ["INPUT", "SELECT", "TEXTAREA"].includes(
    input.tagName
  );

  // --- NEW LOGIC: Ignore validation if field is untouched and empty ---
  // The 'is-dirty' class is added when the user first interacts with the field.
  if (
    isStandardField &&
    value === "" &&
    !input.classList.contains("is-dirty")
  ) {
    parentWrapper.classList.remove("validated", "error");
    return true; // Treat as valid for now (prevents red error on load)
  }
  // --- END NEW LOGIC ---

  if (value === "" || value === "0") {
    // Only set error state if a value is required and missing
    parentWrapper.classList.add("error");
    parentWrapper.classList.remove("validated");
    return false;
  }

  // If we reach here, the field has a selected value (for selects) or some content (for text fields).
  // Remove the error class initially as the value is not empty.
  parentWrapper.classList.remove("error");

  switch (type) {
    case "email":
      // Simple email pattern: a@b.c
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      isValid = emailPattern.test(value);
      break;

    case "text_strict":
      // Pattern checks for: letters (a-z), spaces, hyphens, and single quotes (common in names/places)
      const textStrictPattern = /^[a-zA-Z\s\-'\.]+$/;
      isValid = textStrictPattern.test(value) && value.length >= 2;
      break;

    case "tel_10": // Phone No. and Mobile No.
      // Must be exactly 10 digits and only numbers
      const telPattern = /^\d{10}$/;
      isValid = telPattern.test(value);
      break;

    case "number_strict": // Annual Family Income (only numbers)
      // Must be one or more digits and a positive value
      const numberPattern = /^\d+$/;
      isValid = numberPattern.test(value) && parseInt(value) > 0;
      break;

    case "textarea":
      // Check for non-empty and minimum length for text areas
      isValid = value.length >= 5;
      break;

    case "select":
      // The value is not "" (handled above), so it's a valid selection.
      isValid = true;
      break;

    default:
      // Default validation (covers all other text)
      isValid = value.length >= 2;
      break;
  }

  // 2. Update the UI based on validation result
  if (isValid) {
    parentWrapper.classList.add("validated");
    parentWrapper.classList.remove("error");
  } else {
    parentWrapper.classList.add("error");
    parentWrapper.classList.remove("validated");
  }

  return isValid;
}

// =================================================================
// 2. FORM STATE AND NAVIGATION LOGIC
// =================================================================

let currentPage = 1;
const totalPages = 3;
let pages;
let navTabs;
let prevBtn;
let nextBtn;
let submitBtn;
let modal;
let errorMessage;

// --- Helper Functions ---

function updateNavButtons() {
  prevBtn.style.visibility = currentPage > 1 ? "visible" : "hidden";
  nextBtn.style.display = currentPage < totalPages ? "inline-flex" : "none";
  submitBtn.style.display = currentPage === totalPages ? "inline-flex" : "none";
}

function showPage(pageNumber) {
  pages.forEach((p) => p.classList.remove("active"));
  const targetPageElement = document.getElementById(`page${pageNumber}`);
  if (targetPageElement) {
    targetPageElement.classList.add("active");
    currentPage = pageNumber;
  }

  navTabs.forEach((t) => t.classList.remove("active"));
  document
    .querySelector(`.nav-tab[data-page='${pageNumber}']`)
    ?.classList.add("active");

  updateNavButtons();
}

function showModal(msg) {
  document.getElementById("errorMessage").innerHTML = msg;
  modal.style.display = "flex";
}

function closeModal() {
  modal.style.display = "none";
}

function toggleSection(radioName, sectionId) {
  const radios = document.querySelectorAll(`input[name="${radioName}"]`);
  const section = document.getElementById(sectionId);

  const checkState = () => {
    const selectedValue = document.querySelector(
      `input[name="${radioName}"]:checked`
    )?.value;
    const shouldShow = selectedValue === "Yes";
    section.style.display = shouldShow ? "block" : "none";

    // When section is hidden, remove error state from its fields
    if (!shouldShow) {
      section
        .querySelectorAll(".form-group-validation-wrapper")
        .forEach((wrapper) => {
          wrapper.classList.remove("validated", "error");
        });
    }
  };

  radios.forEach((radio) => radio.addEventListener("change", checkState));
  checkState(); // Run on load
}

/**
 * Global function to dynamically populate the Course dropdown
 * based on the selected Institution.
 */
function updatePrograms() {
  // 1. Get the selected College ID
  const collegeSelect = document.getElementById("institution_name");
  const selectedCollegeId = collegeSelect.value;

  // 2. Get the Course dropdown element
  const programSelect = document.getElementById("course");

  // 3. Clear existing options in the Course dropdown
  programSelect.innerHTML = '<option value="">-- SELECT COURSE --</option>';

  // 4. Check if a valid college was selected
  // NOTE: 'collegePrograms' must be globally defined (see file header)
  if (
    selectedCollegeId &&
    typeof collegePrograms !== "undefined" &&
    collegePrograms[selectedCollegeId]
  ) {
    // Retrieve the programs for the selected college ID
    const programs = collegePrograms[selectedCollegeId].programs;

    // 5. Populate the Course dropdown with new options
    programs.forEach((program) => {
      const option = document.createElement("option");
      // The value is the program ID, and the text is the program name
      option.value = program.id;
      option.textContent = program.name;
      programSelect.appendChild(option);
    });

    // Optionally, enable the course select box if it was disabled
    programSelect.disabled = false;
  } else {
    // If no college is selected or data is missing, keep the placeholder
    // and disable the course select box
    programSelect.disabled = true;
  }
}

function updateSemesters() {
  const yearSelect = document.getElementById("year_of_study");
  const year = parseInt(yearSelect.value);
  const semSelect = document.getElementById("semester");

  // Reset semester dropdown
  semSelect.innerHTML = '<option value="">-- Select Semester --</option>';

  // --- THIS IS THE FIX ---
  // If a year is selected (e.g., year > 0)
  if (year > 0) {
    // Enable the dropdown
    semSelect.disabled = false;

    // Assuming two semesters per year
    const startSem = (year - 1) * 2 + 1;
    const endSem = year * 2;

    // Loop and add the correct semesters
    for (let i = startSem; i <= endSem; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      semSelect.appendChild(opt);
    }
  } else {
    // If no year is selected, disable it
    semSelect.disabled = true;
  }
  // --- END OF FIX ---

  // Re-validate the semester field to clear any errors
  validateField(semSelect);

  // Force validation on the year field after selection
  validateField(yearSelect);
}

// =================================================================
// 3. PAGE VALIDATION (Used for Next/Submit buttons and Nav Tabs)
// =================================================================

function validatePage(pageNumber) {
  let pageElement = document.getElementById(`page${pageNumber}`);
  let isPageValid = true;
  let errorMessages = [];
  let firstErrorElement = null;

  // A. Validate standard fields using the live validation function
  const standardFields = pageElement.querySelectorAll(
    ".form-group-validation-wrapper input, .form-group-validation-wrapper select, .form-group-validation-wrapper textarea"
  );

  standardFields.forEach((field) => {
    // Skip validation if the field is disabled or its parent is hidden
    if (
      field.disabled ||
      field.closest(".conditional-section")?.style.display === "none"
    ) {
      return;
    }

    if (!validateField(field)) {
      isPageValid = false;
      // Get the label text for the error message
      const label =
        pageElement
          .querySelector(`label[for='${field.id}']`)
          ?.textContent.replace(":", "")
          .trim() || field.name;
      errorMessages.push(`- **${label}:** Field is incomplete or invalid.`);

      if (!firstErrorElement) firstErrorElement = field;
    }
  });

  // B. Validate Page 3 specific required uploads/radios (No changes to this logic)
  if (pageNumber === 3) {
    const requiredRadios = ["ex_servicemen", "disabled", "parent_vmrf"];
    requiredRadios.forEach((name) => {
      if (!document.querySelector(`input[name="${name}"]:checked`)) {
        isPageValid = false;
        errorMessages.push(
          `- **${name
            .replace(/_/g, " ")
            .toUpperCase()}:** Please select an option.`
        );
        if (!firstErrorElement)
          firstErrorElement = document.querySelector(`input[name="${name}"]`);
      }
    });

    const conditionalUploads = [
      {
        check: document.getElementById("disabled_yes")?.checked,
        name: "disability_proof",
        msg: "Disability Proof",
      },
      {
        check: document.getElementById("parent_vmrf_yes")?.checked,
        name: "parent_vmrf_proof",
        msg: "VMRF Proof",
      },
    ];

    conditionalUploads.forEach((item) => {
      if (item.check) {
        const fileInput = document.querySelector(`input[name="${item.name}"]`);
        if (!fileInput || fileInput.files.length === 0) {
          isPageValid = false;
          errorMessages.push(
            `- **${item.msg}:** Required proof document is missing.`
          );
          if (!firstErrorElement)
            firstErrorElement =
              fileInput?.closest(".upload-area") || firstErrorElement;
        }
      }
    });
  }

  if (!isPageValid) {
    const header = `<h3>⚠️ Missing Information!</h3><p>Please complete the following required fields on this page:</p><ul>`;
    const footer = "</ul><p>The first missing field will be highlighted.</p>";
    const message =
      header + errorMessages.map((msg) => `<li>${msg}</li>`).join("") + footer;

    showModal(message);

    if (firstErrorElement) {
      // Smoothly scroll to the first error element
      firstErrorElement.scrollIntoView({ behavior: "smooth", block: "center" });

      // Temporary highlight for visibility
      const highlightTarget =
        firstErrorElement.closest(".form-group-validation-wrapper") ||
        firstErrorElement;
      highlightTarget.style.boxShadow = "0 0 0 3px var(--vibrant-pink)";

      setTimeout(() => {
        highlightTarget.style.boxShadow = "";
      }, 4000);
    }
  }

  return isPageValid;
}

function nextPage() {
  if (validatePage(currentPage)) {
    document
      .querySelector(".card")
      .scrollIntoView({ behavior: "smooth", block: "start" });
    setTimeout(() => showPage(currentPage + 1), 10);
  }
}

function prevPage() {
  document
    .querySelector(".card")
    .scrollIntoView({ behavior: "smooth", block: "start" });
  showPage(currentPage - 1);
}

// =================================================================
// 4. FILE UPLOAD LOGIC (No changes)
// =================================================================

function showPreview(uploadArea, file) {
  const oldPreview = uploadArea.querySelector(".file-preview");
  if (oldPreview) oldPreview.remove();

  const preview = document.createElement("div");
  preview.classList.add("file-preview");
  // Inline styles for display
  preview.style.display = "inline-block";
  preview.style.marginTop = "10px";
  preview.style.position = "relative";
  preview.style.marginLeft = "10px";

  if (file.type.startsWith("image/")) {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.style.maxWidth = "100px";
    img.maxHeight = "100px";
    img.style.borderRadius = "8px";
    img.style.objectFit = "cover";
    img.onload = () => URL.revokeObjectURL(img.src);
    preview.appendChild(img);
  } else {
    const icon = document.createElement("i");
    icon.className = "fas fa-file-alt";
    icon.style.marginRight = "8px";
    icon.style.color = "var(--electric-blue)";
    preview.appendChild(icon);

    const span = document.createElement("span");
    span.textContent = file.name;
    span.style.fontSize = "0.9rem";
    span.style.fontWeight = "500";
    preview.appendChild(span);
  }

  // X button
  const removeBtn = document.createElement("button");
  removeBtn.textContent = "×";
  removeBtn.style.position = "absolute";
  removeBtn.style.top = "-8px";
  removeBtn.style.right = "-8px";
  removeBtn.style.background = "var(--vibrant-pink)";
  removeBtn.style.color = "white";
  removeBtn.style.border = "none";
  removeBtn.style.borderRadius = "50%";
  removeBtn.style.cursor = "pointer";
  removeBtn.style.width = "20px";
  removeBtn.style.height = "20px";
  removeBtn.style.lineHeight = "16px";
  removeBtn.style.textAlign = "center";
  removeBtn.style.padding = "0";
  removeBtn.style.boxShadow = "0 2px 5px rgba(0,0,0,0.2)";

  removeBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const fileInput = uploadArea.querySelector("input[type='file']");
    fileInput.value = "";
    preview.remove();
    // Check if removing the file makes the field invalid for page 3
    validatePage(currentPage);
  });

  preview.appendChild(removeBtn);
  uploadArea.appendChild(preview);

  // Check validation state after a file is added
  validatePage(currentPage);
}

// =================================================================
// 5. INITIALIZATION (CONSOLIDATED)
// =================================================================

document.addEventListener("DOMContentLoaded", () => {
  // 1. Assign global elements
  pages = document.querySelectorAll(".page");
  navTabs = document.querySelectorAll(".nav-tab");
  prevBtn = document.getElementById("prevBtn");
  nextBtn = document.getElementById("nextBtn");
  submitBtn = document.getElementById("submitBtn");
  modal = document.getElementById("errorModal");
  errorMessage = document.getElementById("errorMessage");

  // 2. Initial Page Load
  showPage(1);

  // 3. Attach Nav Tab click handlers
  navTabs.forEach((tab) => {
    tab.addEventListener("click", (e) => {
      const targetPage = parseInt(e.target.getAttribute("data-page"));
      if (targetPage > currentPage && !validatePage(currentPage)) {
        return;
      }
      showPage(targetPage);
    });
  });

  // 4. Real-Time Validation Event Listeners
  const validatedFields = document.querySelectorAll(
    ".form-group-validation-wrapper input, .form-group-validation-wrapper select, .form-group-validation-wrapper textarea"
  );

  validatedFields.forEach((field) => {
    // 1. On "input" (typing), validate immediately (for text fields)
    field.addEventListener("input", () => {
      field.classList.add("is-dirty"); // Mark as dirty
      validateField(field);
    });

    // 2. On "change" (dropdown selection, checkbox/radio click), validate immediately
    field.addEventListener("change", () => {
      field.classList.add("is-dirty"); // Mark as dirty
      validateField(field);
    });

    // 3. On "blur" (leaving the field), mark as dirty and validate.
    field.addEventListener("blur", () => {
      // This is crucial for empty text fields that were never typed in.
      field.classList.add("is-dirty");
      validateField(field);
    });
  });

  // 5. Dynamic Dropdown Listeners (Must also mark field as dirty)
  document
    .getElementById("institution_name")
    ?.addEventListener("change", function () {
      this.classList.add("is-dirty"); // Mark as dirty
      updatePrograms();
    });
  document.getElementById("course")?.addEventListener("change", function () {
    this.classList.add("is-dirty"); // Mark as dirty
    validateField(this);
  });
  document
    .getElementById("year_of_study")
    ?.addEventListener("change", function () {
      this.classList.add("is-dirty"); // Mark as dirty
      updateSemesters();
    });
  document.getElementById("semester")?.addEventListener("change", function () {
    this.classList.add("is-dirty"); // Mark as dirty
    validateField(this);
  });

  // 6. Conditional Section Toggling (Page 3)
  toggleSection("ex_servicemen", "ex_servicemen_section");
  toggleSection("disabled", "disabled_section");
  toggleSection("parent_vmrf", "parent_vmrf_section");

  // 7. File Upload Listeners (same as before)
  const uploadAreas = document.querySelectorAll(".upload-area");
  uploadAreas.forEach((uploadArea) => {
    const fileInput = uploadArea.querySelector("input[type='file']");
    if (!fileInput) return;

    // Click, Drag, Drop handlers
    uploadArea.addEventListener("click", () => fileInput.click());
    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.classList.add("dragover");
    });
    uploadArea.addEventListener("dragleave", () => {
      uploadArea.classList.remove("dragover");
    });
    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.classList.remove("dragover");
      if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        showPreview(uploadArea, fileInput.files[0]);
      }
    });

    // File selection handler
    fileInput.addEventListener("change", () => {
      if (fileInput.files.length > 0) {
        showPreview(uploadArea, fileInput.files[0]);
      }
    });
  });

  // 8. Close modal on outside click
  modal.addEventListener("click", (event) => {
    if (event.target === modal) {
      closeModal();
    }
  });
});
